<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOVINETCONDE | Expertos en Tecnolog√≠a</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #000000;
            --accent: #ff8c00; /* Naranja corporativo */
            --text: #333333;
            --bg-glass: rgba(255, 255, 255, 0.9); 
            --success: #2ecc71; /* Verde confirmado */
            --pending: #f39c12; /* Naranja pendiente */
            --error: #e74c3c;
        }

        body { 
            margin: 0; font-family: 'Montserrat', sans-serif; color: var(--text); background-color: #000; 
            background-image: url('fondo.JPG');
            background-repeat: no-repeat; background-position: center center; background-attachment: fixed; background-size: cover;       
            touch-action: manipulation;
        }

        /* NAVEGACI√ìN */
        .navbar { background: rgba(255, 255, 255, 0.95); padding: 10px 0; position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 0 15px; display: flex; flex-direction: column; gap: 10px; }
        .nav-top { display: flex; justify-content: space-between; align-items: center; }
        .logo-container { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--primary); }
        .logo-text { font-size: 1.4rem; font-weight: 800; margin: 0; }
        .logo-text span { color: var(--accent); }
        .nav-icons { display: flex; gap: 15px; }
        .btn-icon { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--primary); position: relative; }
        
        .nav-menu { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .menu-btn { background: rgba(255,255,255,0.8); border: none; padding: 8px 15px; border-radius: 20px; font-weight: 600; cursor: pointer; white-space: nowrap; font-size: 0.9rem; transition: 0.3s; }
        .menu-btn.active, .menu-btn:hover { background: var(--accent); color: white; }

        /* CONTENEDORES */
        .container { 
            max-width: 1200px; margin: 20px auto; padding: 20px; 
            border-radius: 15px; background: var(--bg-glass);
            backdrop-filter: blur(8px); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .hidden { display: none !important; }
        .section-title { text-align: center; color: var(--primary); text-transform: uppercase; margin-bottom: 20px; border-bottom: 2px solid var(--accent); display: inline-block; padding-bottom: 5px; font-weight: 800; }
        .center-wrapper { text-align: center; }

        /* CARDS */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .product-card, .repair-card, .review-card { 
            background: rgba(255, 255, 255, 0.85); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid rgba(0,0,0,0.1); position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.05); 
        }
        .product-photo { width: 100%; height: 220px; object-fit: cover; border-radius: 5px; }
        .brand-tag, .condition-tag { position: absolute; top: 15px; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; color: white; }
        .brand-tag { left: 15px; background: rgba(0,0,0,0.8); }
        .condition-tag { right: 15px; background: var(--success); }

        .price { font-size: 1.3rem; font-weight: 800; color: var(--accent); margin: 10px 0; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; text-transform: uppercase; margin-top: 5px; }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); padding: 10px; width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold; text-transform: uppercase; margin-top: 5px; }

        /* ESTADO DE PEDIDOS (USER PROFILE) */
        .order-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #ccc; text-align: left; }
        .order-card.pendiente { border-left-color: var(--pending); }
        .order-card.confirmado { border-left-color: var(--success); background: #f0fff4; }
        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; color: white; font-weight: bold; margin-bottom: 5px; }
        .bg-pending { background: var(--pending); }
        .bg-success { background: var(--success); }

        /* REVIEWS */
        .stars { color: gold; font-size: 1.2rem; }
        .review-card { text-align: left; border-left: 3px solid var(--accent); }
        
        /* ADMIN & FORMS */
        .form-box { max-width: 600px; margin: 0 auto; background: rgba(255,255,255,0.9); padding: 30px; border-radius: 10px; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; background: rgba(255,255,255,0.9); }
        
        .admin-panel { background: rgba(255, 248, 225, 0.95); border: 2px dashed var(--accent); margin-bottom: 20px; padding: 20px; }
        .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; overflow-x: auto; }
        .admin-tab-btn { background: none; border: none; font-weight: bold; cursor: pointer; opacity: 0.5; font-size: 0.9rem; white-space: nowrap; }
        .admin-tab-btn.active { opacity: 1; color: var(--accent); border-bottom: 2px solid var(--accent); }
        
        .admin-actions { display: flex; gap: 5px; margin-top: 5px; }
        .btn-edit { background: #f1c40f; padding: 5px; border-radius:5px; border:none; cursor:pointer; flex:1; }
        .btn-delete { background: #e74c3c; color:white; padding: 5px; border-radius:5px; border:none; cursor:pointer; flex:1; }
        .btn-confirm { background: var(--success); color:white; padding: 5px; border-radius:5px; border:none; cursor:pointer; flex:2; font-weight:bold; }

        /* MODALES */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: rgba(255,255,255,0.98); padding: 30px; width: 90%; max-width: 500px; border-radius: 10px; position: relative; max-height: 90vh; overflow-y: auto; }
        .close { position: absolute; top: 10px; right: 20px; font-size: 1.8rem; cursor: pointer; }
        
        .profile-tabs { display: flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #eee; }
        .profile-tab { flex:1; padding:10px; border:none; background:none; cursor:pointer; font-weight:bold; opacity:0.6; }
        .profile-tab.active { opacity:1; border-bottom:2px solid var(--accent); color: var(--accent); }

        footer { text-align: center; padding: 30px; background: rgba(17,17,17,0.95); color: white; margin-top: 50px; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-top">
                <a href="#" class="logo-container">
                    <h1 class="logo-text">MOVINET<span>CONDE</span></h1>
                </a>
                <div class="nav-icons">
                    <button onclick="abrirModal('cart-modal')" class="btn-icon"><i class="fas fa-shopping-cart"></i> <span id="cart-count">0</span></button>
                    <button onclick="gestionarPerfil()" class="btn-icon"><i class="fas fa-user-circle"></i></button>
                    <button onclick="abrirModal('admin-login-modal')" class="btn-icon"><i class="fas fa-lock"></i></button>
                </div>
            </div>
            <div class="nav-menu">
                <button onclick="verSeccion('catalogo')" class="menu-btn active" id="btn-catalogo">üì± M√≥viles</button>
                <button onclick="verSeccion('pcs')" class="menu-btn" id="btn-pcs">üñ•Ô∏è PC</button>
                <button onclick="verSeccion('reparaciones')" class="menu-btn" id="btn-reparaciones">üîß Taller</button>
                <button onclick="verSeccion('resenas')" class="menu-btn" id="btn-resenas">‚≠ê Opiniones</button>
                <button onclick="verSeccion('webs')" class="menu-btn" id="btn-webs">üíª Web</button>
            </div>
        </div>
    </nav>

    <div id="admin-panel" class="container admin-panel hidden">
        <h3 style="margin-top:0;">Panel de Administraci√≥n</h3>
        <div class="admin-tabs">
            <button class="admin-tab-btn active" onclick="verAdminTab('pedidos')">üì¶ Pedidos Clientes</button>
            <button class="admin-tab-btn" onclick="verAdminTab('citas')">üîß Citas Taller</button>
            <button class="admin-tab-btn" onclick="verAdminTab('productos')">M√≥viles</button>
            <button class="admin-tab-btn" onclick="verAdminTab('pcs')">PC/Gaming</button>
            <button class="admin-tab-btn" onclick="verAdminTab('reparaciones')">Servicios</button>
        </div>

        <div id="admin-tab-pedidos">
            <h4>Pedidos Pendientes de Confirmar</h4>
            <div id="admin-orders-list" class="grid-container" style="grid-template-columns: 1fr;"></div>
        </div>

        <div id="admin-tab-citas" class="hidden">
            <h4>Solicitudes de Reparaci√≥n</h4>
            <div id="admin-citas-list" class="grid-container" style="grid-template-columns: 1fr;"></div>
        </div>

        <div id="admin-tab-productos" class="hidden">
            <h4>A√±adir M√≥vil</h4>
            <form id="addProductForm">
                <input type="text" id="newBrand" placeholder="Marca" required>
                <input type="text" id="newName" placeholder="Modelo" required>
                <input type="number" id="newPrice" placeholder="Precio" required>
                <input type="text" id="newImg" placeholder="URL Imagen (o dejar vac√≠o)" style="display:none;"> <button type="submit" class="btn-primary">A√±adir M√≥vil</button>
            </form>
            <div style="margin-top:10px; font-size:0.8rem; color:#666;">*Usa el formulario completo anterior para subir fotos. Esto es un acceso r√°pido.</div>
        </div>

        <div id="admin-tab-pcs" class="hidden"><p>Gesti√≥n de PCs (Usa l√≥gica similar a m√≥viles)</p></div>
        <div id="admin-tab-reparaciones" class="hidden"><p>Gesti√≥n de Servicios</p></div>

        <button onclick="cerrarSesionAdmin()" style="margin-top:20px; background:#333; color:white; border:none; padding:10px; width:100%;">Cerrar Admin</button>
    </div>

    <div id="sec-catalogo" class="container">
        <div class="center-wrapper"><h2 class="section-title">M√≥viles</h2></div>
        <div id="productos-container" class="grid-container">Cargando...</div>
    </div>

    <div id="sec-pcs" class="container hidden">
        <div class="center-wrapper"><h2 class="section-title">Ordenadores</h2></div>
        <div id="pcs-container" class="grid-container">Cargando...</div>
    </div>

    <div id="sec-reparaciones" class="container hidden">
        <div class="center-wrapper"><h2 class="section-title">Reparaciones</h2></div>
        <div id="reparaciones-container" class="grid-container" style="margin-bottom: 30px;"></div>
        
        <div class="form-box glass-effect">
            <h3>Solicitar Reparaci√≥n / Presupuesto</h3>
            <p style="font-size:0.9rem;">Tu solicitud quedar√° registrada en tu perfil.</p>
            <form id="tallerForm">
                <input type="text" id="tallerNombre" placeholder="Tu Nombre" required>
                <input type="text" id="tallerDispositivo" placeholder="Dispositivo y Aver√≠a (Ej: iPhone X Pantalla Rota)" required>
                <button type="submit" class="btn-primary">ENVIAR SOLICITUD Y CONTACTAR</button>
            </form>
        </div>
    </div>

    <div id="sec-resenas" class="container hidden">
        <div class="center-wrapper"><h2 class="section-title">Opiniones de Clientes</h2></div>
        <div style="text-align:center; margin-bottom:20px;">
            <button onclick="abrirModal('review-modal')" class="btn-primary" style="width:auto; padding: 10px 30px;">ESCRIBIR RESE√ëA</button>
        </div>
        <div id="reviews-container" class="grid-container">
            <p style="text-align:center;">Cargando opiniones...</p>
        </div>
    </div>

    <div id="sec-webs" class="container hidden">
        <div class="center-wrapper"><h2 class="section-title">Dise√±o Web</h2></div>
        <p style="text-align:center;">Cont√°ctanos para tu web a medida.</p>
    </div>

    <div id="cart-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('cart-modal')">&times;</span>
            <h2>Tu Pedido</h2>
            <ul id="cart-items" style="list-style:none; padding:0; margin:20px 0;"></ul>
            <h3>Total: <span id="total-price">0</span>‚Ç¨</h3>
            <p style="font-size:0.8rem; color:#666;">Al pulsar "Comprar", el pedido se guardar√° en tu perfil y se abrir√° WhatsApp.</p>
            <button onclick="realizarPedido()" class="btn-primary">CONFIRMAR Y ABRIR WHATSAPP</button>
        </div>
    </div>

    <div id="profile-modal" class="modal hidden">
        <div class="modal-content" style="max-width:600px;">
            <span class="close" onclick="cerrarModal('profile-modal')">&times;</span>
            <h2 id="profile-name">Mi Perfil</h2>
            
            <div class="profile-tabs">
                <button class="profile-tab active" onclick="verTabPerfil('pedidos')">Mis Pedidos</button>
                <button class="profile-tab" onclick="verTabPerfil('reparaciones')">Reparaciones</button>
                <button class="profile-tab" onclick="verTabPerfil('favoritos')">Favoritos</button>
            </div>

            <div id="tab-pedidos">
                <div id="user-orders-list">Cargando pedidos...</div>
            </div>
            <div id="tab-reparaciones" class="hidden">
                <div id="user-repairs-list">Cargando reparaciones...</div>
            </div>
            <div id="tab-favoritos" class="hidden">
                <ul id="fav-list" style="list-style:none; padding:0"></ul>
            </div>

            <button onclick="auth.signOut(); cerrarModal('profile-modal');" class="btn-delete" style="background:#333; margin-top:20px;">Cerrar Sesi√≥n</button>
        </div>
    </div>

    <div id="review-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('review-modal')">&times;</span>
            <h3>Escribir Opini√≥n</h3>
            <form id="addReviewForm">
                <input type="text" id="reviewName" placeholder="Tu Nombre" required>
                <select id="reviewStars" required>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excelente</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Muy bueno</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê Normal</option>
                    <option value="2">‚≠ê‚≠ê Regular</option>
                    <option value="1">‚≠ê Malo</option>
                </select>
                <textarea id="reviewText" placeholder="Cu√©ntanos tu experiencia..." rows="3" required></textarea>
                <button type="submit" class="btn-primary">PUBLICAR RESE√ëA</button>
            </form>
        </div>
    </div>

    <div id="auth-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('auth-modal')">&times;</span>
            <h2 style="text-align:center">Acceso Clientes</h2>
            <p style="text-align:center; font-size:0.9rem;">Inicia sesi√≥n para guardar tus pedidos y ver su estado.</p>
            <form id="authForm">
                <input type="email" id="authEmail" placeholder="Email" required>
                <input type="password" id="authPass" placeholder="Contrase√±a" required>
                <div style="display:flex; gap:10px;">
                    <button type="button" class="btn-primary" onclick="handleAuth('login')">ENTRAR</button>
                    <button type="button" class="btn-secondary" onclick="handleAuth('register')">REGISTRARSE</button>
                </div>
                <p id="authError" style="color:red; text-align:center; font-size:0.8rem; margin-top:10px;"></p>
            </form>
        </div>
    </div>
    
    <div id="admin-login-modal" class="modal hidden">
        <div class="modal-content" style="max-width:300px; text-align:center;">
            <span class="close" onclick="cerrarModal('admin-login-modal')">&times;</span>
            <h3>Zona Admin</h3>
            <input type="password" id="adminPassInput" placeholder="Contrase√±a">
            <button onclick="verificarAdmin()" class="btn-primary">Entrar</button>
        </div>
    </div>

    <footer>
        <a href="https://www.instagram.com/movinetconde/" target="_blank" style="color:orange; font-size:2rem;"><i class="fab fa-instagram"></i></a>
        <p>&copy; 2025 MOVINETCONDE</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAO9sshvU5zUf_S9d12toWwrioeXBonlRc",
            authDomain: "movinet-conde-web.firebaseapp.com",
            projectId: "movinet-conde-web",
            appId: "1:867268264562:web:f28e33585cdcde3d8e78eb"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let carrito = []; let usuarioActual = null; let esAdmin = false; let favoritos = [];
        const MI_TELEFONO = "34613509309"; 

        // --- AUTH ---
        auth.onAuthStateChanged(u => { 
            usuarioActual = u; 
            if(u) {
                cerrarModal('auth-modal'); 
                document.getElementById('profile-name').innerText = "Perfil de " + (u.email.split('@')[0]);
                cargarDatosPerfil();
            } else {
                favoritos = [];
            }
        });

        function handleAuth(type) {
            const em = document.getElementById('authEmail').value; const pw = document.getElementById('authPass').value;
            const err = document.getElementById('authError'); err.innerText="";
            if(!em || !pw){ err.innerText="Rellena todo."; return; }
            const p = type === 'login' ? auth.signInWithEmailAndPassword(em,pw) : auth.createUserWithEmailAndPassword(em,pw);
            p.catch(e => err.innerText = e.message);
        }

        // --- NAVEGACI√ìN ---
        function verSeccion(id) {
            document.querySelectorAll('[id^="sec-"]').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`sec-${id}`).classList.remove('hidden');
            document.getElementById(`btn-${id}`).classList.add('active');
        }

        // --- GESTI√ìN DE PEDIDOS Y CITAS (L√≥gica Nueva) ---
        
        // 1. REALIZAR PEDIDO (Guardar en DB -> WhatsApp)
        async function realizarPedido(){
            if(!carrito.length) return;
            
            if(!usuarioActual) {
                alert("Debes iniciar sesi√≥n para que el pedido se guarde en tu historial.");
                abrirModal('auth-modal');
                return;
            }

            let total = 0;
            let itemsTexto = "";
            carrito.forEach(i => { total += i.p; itemsTexto += `${i.n} (${i.p}‚Ç¨), `; });

            // Guardar en Firestore
            try {
                await db.collection('pedidos').add({
                    uid: usuarioActual.uid,
                    email: usuarioActual.email,
                    items: carrito,
                    total: total,
                    fecha: new Date().toISOString(),
                    estado: 'pendiente' // Estado inicial
                });

                // Enviar a WhatsApp
                let m = `Hola, soy ${usuarioActual.email}. He realizado un pedido en la web:\n${itemsTexto}\nTotal: ${total}‚Ç¨`;
                window.open(`https://wa.me/${MI_TELEFONO}?text=${encodeURIComponent(m)}`,'_blank');
                
                carrito = []; 
                document.getElementById('cart-count').innerText = "0";
                cerrarModal('cart-modal');
                alert("Pedido registrado en tu perfil y WhatsApp abierto.");
                cargarDatosPerfil(); // Refrescar perfil
            } catch(e) {
                alert("Error al guardar pedido: " + e.message);
            }
        }

        // 2. SOLICITAR REPARACI√ìN (Guardar en DB -> WhatsApp)
        document.getElementById('tallerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('tallerNombre').value;
            const disp = document.getElementById('tallerDispositivo').value;

            if(!usuarioActual) { alert("Inicia sesi√≥n para guardar el seguimiento."); abrirModal('auth-modal'); return; }

            try {
                await db.collection('citas').add({
                    uid: usuarioActual.uid,
                    email: usuarioActual.email,
                    nombre: nombre,
                    dispositivo: disp,
                    fecha: new Date().toISOString(),
                    estado: 'pendiente'
                });
                
                window.open(`https://wa.me/${MI_TELEFONO}?text=${encodeURIComponent(`Hola, soy ${nombre}. Consulta taller: ${disp}`)}`,'_blank');
                document.getElementById('tallerForm').reset();
            } catch(e) { alert("Error: " + e.message); }
        });

        // 3. RESE√ëAS
        document.getElementById('addReviewForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const n = document.getElementById('reviewName').value;
            const s = document.getElementById('reviewStars').value;
            const t = document.getElementById('reviewText').value;

            await db.collection('resenas').add({
                nombre: n, estrellas: s, texto: t, fecha: new Date().toISOString(),
                uid: usuarioActual ? usuarioActual.uid : 'anonimo'
            });
            alert("¬°Gracias por tu opini√≥n!");
            cerrarModal('review-modal');
            cargarResenas();
        });

        function cargarResenas() {
            db.collection('resenas').orderBy('fecha', 'desc').limit(10).onSnapshot(snap => {
                const div = document.getElementById('reviews-container');
                div.innerHTML = "";
                snap.forEach(doc => {
                    const r = doc.data();
                    const stars = "‚≠ê".repeat(r.estrellas);
                    div.innerHTML += `
                        <div class="review-card">
                            <div class="stars">${stars}</div>
                            <b>${r.nombre}</b>
                            <p>"${r.texto}"</p>
                        </div>
                    `;
                });
            });
        }

        // --- PERFIL DE USUARIO ---
        function gestionarPerfil() { usuarioActual ? abrirModal('profile-modal') : abrirModal('auth-modal'); }
        
        function verTabPerfil(tab) {
            document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.profile-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            event.target.classList.add('active');
        }

        function cargarDatosPerfil() {
            if(!usuarioActual) return;

            // Cargar Pedidos
            db.collection('pedidos').where('uid', '==', usuarioActual.uid).orderBy('fecha', 'desc').onSnapshot(snap => {
                const div = document.getElementById('user-orders-list');
                div.innerHTML = "";
                if(snap.empty) { div.innerHTML = "<p>No tienes pedidos.</p>"; return; }
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const fecha = new Date(d.fecha).toLocaleDateString();
                    const claseEstado = d.estado === 'confirmado' ? 'bg-success' : 'bg-pending';
                    const bordeEstado = d.estado === 'confirmado' ? 'confirmado' : 'pendiente';
                    
                    let listaItems = d.items.map(i => `<li>${i.n}</li>`).join('');

                    div.innerHTML += `
                        <div class="order-card ${bordeEstado}">
                            <div style="display:flex; justify-content:space-between;">
                                <b>${fecha}</b>
                                <span class="status-badge ${claseEstado}">${d.estado.toUpperCase()}</span>
                            </div>
                            <ul style="margin:5px 0; padding-left:20px; font-size:0.9rem;">${listaItems}</ul>
                            <div style="text-align:right; font-weight:bold;">Total: ${d.total}‚Ç¨</div>
                        </div>
                    `;
                });
            });

            // Cargar Citas
            db.collection('citas').where('uid', '==', usuarioActual.uid).orderBy('fecha', 'desc').onSnapshot(snap => {
                const div = document.getElementById('user-repairs-list');
                div.innerHTML = "";
                if(snap.empty) { div.innerHTML = "<p>No tienes reparaciones registradas.</p>"; return; }

                snap.forEach(doc => {
                    const d = doc.data();
                    const claseEstado = d.estado === 'confirmado' ? 'bg-success' : 'bg-pending';
                    const bordeEstado = d.estado === 'confirmado' ? 'confirmado' : 'pendiente';

                    div.innerHTML += `
                        <div class="order-card ${bordeEstado}">
                             <div style="display:flex; justify-content:space-between;">
                                <b>${d.dispositivo}</b>
                                <span class="status-badge ${claseEstado}">${d.estado.toUpperCase()}</span>
                            </div>
                            <p style="margin:5px 0;">${new Date(d.fecha).toLocaleDateString()}</p>
                        </div>
                    `;
                });
            });
            
            // Cargar Favoritos (Simplificado)
            cargarFavoritos();
        }

        // --- ADMIN ---
        function verificarAdmin() { 
            if(document.getElementById('adminPassInput').value === "4354"){ 
                esAdmin = true; 
                document.getElementById('admin-panel').classList.remove('hidden'); 
                cerrarModal('admin-login-modal');
                cargarAdminData(); 
            } else alert("Error"); 
        }

        function verAdminTab(t) {
            document.querySelectorAll('[id^="admin-tab-"]').forEach(x => x.classList.add('hidden'));
            document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`admin-tab-${t}`).classList.remove('hidden');
            event.target.classList.add('active');
        }

        function cargarAdminData() {
            // Cargar TODOS los pedidos para Admin
            db.collection('pedidos').orderBy('fecha', 'desc').onSnapshot(snap => {
                const div = document.getElementById('admin-orders-list'); div.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const btnAccion = d.estado === 'pendiente' 
                        ? `<button class="btn-confirm" onclick="cambiarEstado('pedidos', '${doc.id}', 'confirmado')">‚úÖ Confirmar Pedido</button>` 
                        : `<button class="btn-secondary" onclick="cambiarEstado('pedidos', '${doc.id}', 'pendiente')">‚è™ Reabrir</button>`;
                    
                    div.innerHTML += `
                        <div class="review-card" style="background:${d.estado==='confirmado'?'#e8f5e9':'#fff3e0'}">
                            <small>${d.email} - ${new Date(d.fecha).toLocaleString()}</small>
                            <p><b>Items:</b> ${d.items.map(i=>i.n).join(', ')}</p>
                            <p><b>Total:</b> ${d.total}‚Ç¨</p>
                            ${btnAccion}
                        </div>`;
                });
            });

            // Cargar TODAS las citas para Admin
            db.collection('citas').orderBy('fecha', 'desc').onSnapshot(snap => {
                const div = document.getElementById('admin-citas-list'); div.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const btnAccion = d.estado === 'pendiente' 
                        ? `<button class="btn-confirm" onclick="cambiarEstado('citas', '${doc.id}', 'confirmado')">‚úÖ Reparaci√≥n Lista</button>` 
                        : `<button class="btn-secondary" onclick="cambiarEstado('citas', '${doc.id}', 'pendiente')">‚è™ Poner Pendiente</button>`;
                    
                    div.innerHTML += `
                        <div class="review-card" style="background:${d.estado==='confirmado'?'#e8f5e9':'#fff3e0'}">
                            <small>${d.email} - ${d.nombre}</small>
                            <h3>${d.dispositivo}</h3>
                            ${btnAccion}
                        </div>`;
                });
            });
        }

        function cambiarEstado(col, id, estado) {
            db.collection(col).doc(id).update({ estado: estado });
        }
        function cerrarSesionAdmin() { document.getElementById('admin-panel').classList.add('hidden'); esAdmin=false; }

        // --- CARGA INICIAL DE PRODUCTOS (Reutilizando l√≥gica anterior simplificada) ---
        function cargarProductosBase() {
            db.collection("productos").limit(8).get().then(s => {
                const c = document.getElementById('productos-container'); c.innerHTML = "";
                s.forEach(d => {
                     const p = d.data();
                     c.innerHTML += `<div class="product-card"><h3>${p.nombre}</h3><p class="price">${p.precio}‚Ç¨</p><button class="btn-primary" onclick="addCart('${d.id}','${p.nombre}',${p.precio})">A√±adir</button></div>`;
                });
            });
             db.collection("pcs").limit(4).get().then(s => {
                const c = document.getElementById('pcs-container'); c.innerHTML = "";
                s.forEach(d => {
                     const p = d.data();
                     c.innerHTML += `<div class="product-card"><h3>${p.titulo}</h3><p class="price">${p.precio}‚Ç¨</p><button class="btn-primary" onclick="addCart('${d.id}','${p.titulo}',${p.precio})">A√±adir</button></div>`;
                });
            });
            // Servicios de reparaci√≥n
             db.collection("reparaciones").get().then(s => {
                const c = document.getElementById('reparaciones-container'); c.innerHTML = "";
                s.forEach(d => {
                     const p = d.data();
                     c.innerHTML += `<div class="repair-card"><h4>${p.servicio}</h4><p>${p.precioTexto}</p></div>`;
                });
            });
        }

        // --- UTILIDADES ---
        function addCart(id, n, p){ carrito.push({n,p}); document.getElementById('cart-count').innerText=carrito.length; alert("A√±adido"); }
        window.abrirModal = (id) => { 
            document.getElementById(id).classList.remove('hidden'); 
            if(id === 'cart-modal'){
                const ul = document.getElementById('cart-items'); ul.innerHTML=""; let t=0;
                carrito.forEach(i => { ul.innerHTML+=`<li>${i.n} - ${i.p}‚Ç¨</li>`; t+=i.p; });
                document.getElementById('total-price').innerText = t;
            }
        };
        window.cerrarModal = (id) => document.getElementById(id).classList.add('hidden');

        function cargarFavoritos(){ 
            if(!usuarioActual)return; 
            db.collection('usuarios').doc(usuarioActual.uid).collection('favoritos').get().then(s=>{ 
                const ul = document.getElementById('fav-list'); ul.innerHTML="";
                s.forEach(d => ul.innerHTML += `<li>${d.data().n}</li>`);
            }); 
        }

        // Inicializar
        cargarProductosBase();
        cargarResenas();

    </script>
</body>
</html>
